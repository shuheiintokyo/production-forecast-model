<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Forecast Model</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .sheet-section {
            margin-bottom: 40px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        .sheet-header {
            background-color: #3498db;
            color: white;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
        }
        .sheet-content {
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .product-upper { background-color: #e8f5e8; }
        .product-middle { background-color: #fff2e8; }
        .product-lower { background-color: #e8e8f5; }
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        button {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #219a52;
        }
        .download-btn {
            background-color: #e74c3c;
        }
        .download-btn:hover {
            background-color: #c0392b;
        }
        .note {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .editable {
            background-color: #fff;
            border: 1px solid #007bff;
        }
        .calculated {
            background-color: #f0f0f0;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Production Forecast Model</h1>
        
        <!-- Error Display Area -->
        <div id="errorDisplay" style="display: none; background-color: #ffebee; border: 1px solid #f44336; padding: 10px; margin-bottom: 20px; border-radius: 4px;">
            <strong>Error Details:</strong>
            <div id="errorText" style="font-family: monospace; font-size: 12px; color: #d32f2f; white-space: pre-wrap;"></div>
        </div>
        
        <div class="controls">
            <div style="margin-bottom: 15px;">
                <label for="currentMonthSelect" style="display: block; margin-bottom: 5px; font-weight: bold;">Current Month:</label>
                <select id="currentMonthSelect" onchange="setCurrentMonth(this.value)" style="margin-bottom: 10px; padding: 5px;">
                    <option value="" disabled selected>Please load Excel file first</option>
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label for="fileInput" style="display: block; margin-bottom: 5px; font-weight: bold;">Upload Excel File:</label>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="margin-bottom: 10px;" />
                <button onclick="loadFromFile()">Load Configuration & Forecast</button>
            </div>
            <button onclick="calculateAll()">Calculate All Schedules</button>
            <button onclick="saveData()">Save Data</button>
            <button onclick="resetData()">Reset All Data</button>
            <button onclick="downloadExcel()" class="download-btn">Download Excel File</button>
            <div style="margin-top: 10px; font-size: 12px; color: #666;">
                <strong>Expected Excel format:</strong><br>
                - Sheet 1: "Product Lineup" with columns: Product Name, Product Weight, Material, Production Lead Time<br>
                - Sheet 2: "ClientForcast" with months as headers (can start from any month)<br>
                <br>
                <strong>Timing Rules:</strong><br>
                - Forecast: Need at beginning of month (must be ready in previous month)<br>
                - Material Order: Delivered next month, production starts month after that<br>
                - Production: Added to inventory at end of month<br>
                - Inventory: Shows end-of-month amounts<br>
                <br>
                <strong>Instructions:</strong><br>
                1. Upload your Excel file using the button above<br>
                2. Select your current month from the dropdown<br>
                3. Review the calculated schedules and inventories<br>
                4. Make adjustments by editing the forecast values directly<br>
                5. Save your data to preserve it for next session<br>
                6. Download the updated Excel file when ready
            </div>
        </div>

        <!-- Product Lineup -->
        <div class="sheet-section">
            <div class="sheet-header">1. Product Lineup</div>
            <div class="sheet-content">
                <table id="productLineup">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Product Weight</th>
                            <th>Material</th>
                            <th>Production Lead Time (units/month)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="4" style="text-align: center; color: #666; font-style: italic; padding: 20px;">
                                Please upload an Excel file to load product configuration
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Client Forecast -->
        <div class="sheet-section">
            <div class="sheet-header">2. Client Forecast</div>
            <div class="sheet-content">
                <div class="note">
                    <strong>Note:</strong> Products must be ready in inventory the month before delivery to client.
                </div>
                <table id="clientForecast">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th colspan="8" style="text-align: center;">Months will appear after loading Excel file</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="9" style="text-align: center; color: #666; font-style: italic; padding: 20px;">
                                Please upload an Excel file to load client forecast data
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Factory Line Schedule -->
        <div class="sheet-section">
            <div class="sheet-header">3. Factory Line Schedule</div>
            <div class="sheet-content">
                <div class="note">
                    <strong>Calculation:</strong> Based on client forecast and production capacity constraints.
                </div>
                <table id="factorySchedule">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th colspan="8" style="text-align: center;">Months will appear after loading Excel file</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="9" style="text-align: center; color: #666; font-style: italic; padding: 20px;">
                                Factory schedule will be calculated after loading Excel file
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Material Order Schedule -->
        <div class="sheet-section">
            <div class="sheet-header">4. Material Order Schedule</div>
            <div class="sheet-content">
                <div class="note">
                    <strong>Note:</strong> Material orders delivered next month, production starts month after that.
                </div>
                <table id="materialOrder">
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th colspan="8" style="text-align: center;">Months will appear after loading Excel file</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="9" style="text-align: center; color: #666; font-style: italic; padding: 20px;">
                                Material orders will be calculated after loading Excel file
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Product Inventory -->
        <div class="sheet-section">
            <div class="sheet-header">5. Product Inventory</div>
            <div class="sheet-content">
                <div class="note">
                    <strong>Calculation:</strong> Previous month inventory + Production - Client deliveries
                </div>
                <table id="productInventory">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th colspan="8" style="text-align: center;">Months will appear after loading Excel file</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="9" style="text-align: center; color: #666; font-style: italic; padding: 20px;">
                                Product inventory will be calculated after loading Excel file
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Material Inventory -->
        <div class="sheet-section">
            <div class="sheet-header">6. Material Inventory</div>
            <div class="sheet-content">
                <div class="note">
                    <strong>Calculation:</strong> Previous month inventory + Material deliveries - Material used in production
                </div>
                <table id="materialInventory">
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th colspan="8" style="text-align: center;">Months will appear after loading Excel file</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="9" style="text-align: center; color: #666; font-style: italic; padding: 20px;">
                                Material inventory will be calculated after loading Excel file
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global error handler
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event);
            showError('Error: ' + (event.error?.message || event.message) + '\nFile: ' + event.filename + '\nLine: ' + event.lineno);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event);
            showError('Promise Rejection: ' + event.reason);
        });

        function showError(errorText) {
            const errorDisplay = document.getElementById('errorDisplay');
            const errorTextElement = document.getElementById('errorText');
            if (errorDisplay && errorTextElement) {
                errorTextElement.textContent = errorText;
                errorDisplay.style.display = 'block';
            }
            console.error("Error shown to user:", errorText);
        }

        function hideError() {
            const errorDisplay = document.getElementById('errorDisplay');
            if (errorDisplay) {
                errorDisplay.style.display = 'none';
            }
        }
        
        // Check if XLSX library loaded
        if (typeof XLSX === 'undefined') {
            console.error("XLSX library not loaded!");
            showError("XLSX library failed to load. Please check your internet connection.");
        } else {
            console.log("XLSX library loaded successfully");
        }

        // Data structure to hold all the model data
        const modelData = {
            products: {},
            months: [],
            clientForecast: {},
            startingInventory: {
                products: {},
                materials: {}
            },
            currentMonth: 0
        };

        console.log("ModelData initialized:", modelData);

        // Load data from localStorage on page load
        function loadPersistedData() {
            console.log("Loading persisted data...");
            const saved = localStorage.getItem('productionForecastData');
            if (saved) {
                try {
                    const savedData = JSON.parse(saved);
                    Object.assign(modelData, savedData);
                    console.log("Loaded saved data:", savedData);
                    updateAllTables();
                    updateMonthSelector();
                } catch (e) {
                    console.error('Error loading saved data:', e);
                    showError('Error loading saved data: ' + e.message);
                }
            } else {
                console.log("No saved data found");
            }
        }

        // Save data to localStorage
        function saveData() {
            try {
                console.log("Saving data:", modelData);
                localStorage.setItem('productionForecastData', JSON.stringify(modelData));
                console.log("Data saved successfully");
            } catch (e) {
                console.error('Error saving data:', e);
                showError('Error saving data: ' + e.message);
            }
        }

        // Set current month and update starting inventory
        function setCurrentMonth(monthIndex) {
            console.log("Setting current month to:", monthIndex);
            modelData.currentMonth = parseInt(monthIndex);
            
            if (monthIndex > 0) {
                const prevProductInventory = calculateProductInventoryForMonth(monthIndex - 1);
                const prevMaterialInventory = calculateMaterialInventoryForMonth(monthIndex - 1);
                
                modelData.startingInventory.products = prevProductInventory;
                modelData.startingInventory.materials = prevMaterialInventory;
            }
            
            saveData();
            calculateAll();
        }

        function updateMonthSelector() {
            console.log("Updating month selector...");
            const select = document.getElementById('currentMonthSelect');
            if (!select) {
                console.error("Month selector not found!");
                return;
            }
            
            select.innerHTML = '';
            
            if (modelData.months.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Please load Excel file first';
                option.disabled = true;
                option.selected = true;
                select.appendChild(option);
                console.log("Month selector set to empty state");
            } else {
                modelData.months.forEach(function(month, index) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = month;
                    if (index === modelData.currentMonth) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                console.log("Month selector populated with:", modelData.months);
            }
        }

        // Load data from uploaded Excel file
        async function loadFromFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an Excel file first.');
                return;
            }
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, {
                    cellStyles: true,
                    cellFormulas: true,
                    cellDates: true,
                    cellNF: true,
                    sheetStubs: true
                });
                
                // Load Product Lineup
                if (workbook.SheetNames.includes('Product Lineup')) {
                    const productSheet = workbook.Sheets['Product Lineup'];
                    const productData = XLSX.utils.sheet_to_json(productSheet, {header: 1});
                    
                    modelData.products = {};
                    
                    for (let i = 2; i < productData.length; i++) {
                        const row = productData[i];
                        if (row && row[0] && row[1] && row[2] && row[3]) {
                            const productName = row[0];
                            const weightStr = row[1].toString();
                            const weight = parseInt(weightStr.replace(/[^0-9]/g, ''));
                            const material = row[2];
                            const leadTime = parseInt(row[3]);
                            
                            modelData.products[productName] = {
                                weight: weight,
                                material: material,
                                leadTime: leadTime
                            };
                        }
                    }
                }
                
                // Load Client Forecast
                if (workbook.SheetNames.includes('ClientForcast')) {
                    const forecastSheet = workbook.Sheets['ClientForcast'];
                    const forecastData = XLSX.utils.sheet_to_json(forecastSheet, {header: 1});
                    
                    const headerRow = forecastData[1];
                    modelData.months = [];
                    for (let j = 1; j < headerRow.length; j++) {
                        if (headerRow[j]) {
                            modelData.months.push(headerRow[j]);
                        }
                    }
                    
                    modelData.clientForecast = {};
                    
                    for (let i = 2; i < forecastData.length; i++) {
                        const row = forecastData[i];
                        if (row && row[0] && modelData.products[row[0]]) {
                            const productName = row[0];
                            const forecast = [];
                            
                            for (let j = 1; j <= modelData.months.length; j++) {
                                forecast.push(parseInt(row[j]) || 0);
                            }
                            
                            modelData.clientForecast[productName] = forecast;
                        }
                    }
                }
                
                modelData.currentMonth = 0;
                
                updateProductLineupTable();
                updateClientForecastTable();
                updateMonthSelector();
                calculateAll();
                
                alert('File loaded successfully!');
                
            } catch (error) {
                console.error('Error loading file:', error);
                showError('Error loading file: ' + error.message);
                alert('Error loading file. Please check the file format.');
            }
        }
        
        function updateProductLineupTable() {
            const table = document.getElementById('productLineup');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            
            if (Object.keys(modelData.products).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666; font-style: italic; padding: 20px;">Please upload an Excel file to load product configuration</td></tr>';
                return;
            }
            
            Object.keys(modelData.products).forEach(function(product) {
                const data = modelData.products[product];
                const row = document.createElement('tr');
                row.className = 'product-' + product.toLowerCase();
                row.innerHTML = '<td>' + product + '</td>' +
                    '<td>' + data.weight + 'g</td>' +
                    '<td>' + data.material + '</td>' +
                    '<td class="editable" contenteditable="true" data-product="' + product + '" data-field="leadTime">' + data.leadTime + '</td>';
                tbody.appendChild(row);
            });
        }
        
        function updateClientForecastTable() {
            const table = document.getElementById('clientForecast');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            
            if (Object.keys(modelData.products).length === 0 || modelData.months.length === 0) {
                thead.innerHTML = '<tr><th>Product</th><th colspan="8" style="text-align: center;">Months will appear after loading Excel file</th></tr>';
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666; font-style: italic; padding: 20px;">Please upload an Excel file to load client forecast data</td></tr>';
                return;
            }
            
            let headerHTML = '<tr><th>Product</th>';
            modelData.months.forEach(function(month) {
                headerHTML += '<th>' + month + '</th>';
            });
            headerHTML += '</tr>';
            thead.innerHTML = headerHTML;
            
            tbody.innerHTML = '';
            Object.keys(modelData.products).forEach(function(product) {
                const forecast = modelData.clientForecast[product] || [];
                const row = document.createElement('tr');
                row.className = 'product-' + product.toLowerCase();
                
                let cells = '<td>' + product + '</td>';
                modelData.months.forEach(function(month, monthIndex) {
                    const value = forecast[monthIndex] || 0;
                    cells += '<td class="editable" contenteditable="true">' + value + '</td>';
                });
                
                row.innerHTML = cells;
                tbody.appendChild(row);
            });
        }

        function updateFactoryScheduleTable(factorySchedule) {
            const table = document.getElementById('factorySchedule');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            
            if (Object.keys(modelData.products).length === 0 || modelData.months.length === 0) {
                thead.innerHTML = '<tr><th>Product</th><th colspan="8" style="text-align: center;">Months will appear after loading Excel file</th></tr>';
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666; font-style: italic; padding: 20px;">Factory schedule will be calculated after loading Excel file</td></tr>';
                return;
            }
            
            let headerHTML = '<tr><th>Product</th>';
            modelData.months.forEach(function(month) {
                headerHTML += '<th>' + month + '</th>';
            });
            headerHTML += '</tr>';
            thead.innerHTML = headerHTML;
            
            tbody.innerHTML = '';
            Object.keys(modelData.products).forEach(function(product) {
                const row = document.createElement('tr');
                row.className = 'product-' + product.toLowerCase();
                
                let cells = '<td>' + product + '</td>';
                modelData.months.forEach(function(month, monthIndex) {
                    const value = factorySchedule[product] ? factorySchedule[product][monthIndex] || 0 : 0;
                    cells += '<td class="calculated">' + value + '</td>';
                });
                
                row.innerHTML = cells;
                tbody.appendChild(row);
            });
        }

        // Event handlers
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('editable') && e.target.getAttribute('data-field') === 'leadTime') {
                const product = e.target.getAttribute('data-product');
                const value = parseInt(e.target.textContent) || 0;
                
                if (product && modelData.products[product]) {
                    modelData.products[product].leadTime = value;
                    calculateAll();
                    saveData();
                }
            }
        });

        document.addEventListener('input', function(e) {
            if (e.target.closest('#clientForecast') && e.target.classList.contains('editable')) {
                updateClientForecastData();
                calculateAll();
                saveData();
            }
        });

        function updateClientForecastData() {
            if (Object.keys(modelData.products).length === 0 || modelData.months.length === 0) {
                return;
            }
            
            const table = document.getElementById('clientForecast');
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(function(row, index) {
                const productNames = Object.keys(modelData.products);
                if (index < productNames.length) {
                    const product = productNames[index];
                    const cells = row.querySelectorAll('.editable');
                    const forecast = [];
                    cells.forEach(function(cell) {
                        forecast.push(parseInt(cell.textContent) || 0);
                    });
                    modelData.clientForecast[product] = forecast;
                }
            });
        }

        function calculateAll() {
            if (Object.keys(modelData.products).length === 0 || modelData.months.length === 0) {
                showEmptyTables();
                return;
            }
            
            try {
                updateClientForecastData();
                calculateFactorySchedule();
                calculateMaterialOrders();
                calculateProductInventory();
                calculateMaterialInventory();
                hideError(); // Hide error if calculations succeed
            } catch (error) {
                console.error('Error in calculateAll:', error);
                showError('Calculation error: ' + error.message + '\nStack: ' + error.stack);
            }
        }
        
        function showEmptyTables() {
            const tables = ['factorySchedule', 'materialOrder', 'productInventory', 'materialInventory'];
            tables.forEach(function(tableId) {
                const table = document.getElementById(tableId);
                const thead = table.querySelector('thead');
                const tbody = table.querySelector('tbody');
                
                thead.innerHTML = '<tr><th>' + (tableId.includes('material') ? 'Material' : 'Product') + '</th><th colspan="8" style="text-align: center;">Months will appear after loading Excel file</th></tr>';
                
                const message = tableId.includes('factory') ? 'Factory schedule will be calculated after loading Excel file' :
                               tableId.includes('materialOrder') ? 'Material orders will be calculated after loading Excel file' :
                               tableId.includes('productInventory') ? 'Product inventory will be calculated after loading Excel file' :
                               'Material inventory will be calculated after loading Excel file';
                
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666; font-style: italic; padding: 20px;">' + message + '</td></tr>';
            });
        }

        function calculateFactorySchedule() {
            if (Object.keys(modelData.products).length === 0 || modelData.months.length === 0) {
                return;
            }
            
            const materialDemand = {};
            const totalDemandByProduct = {};
            
            Object.keys(modelData.products).forEach(function(product) {
                const forecast = modelData.clientForecast[product] || [];
                const totalUnits = forecast.reduce(function(sum, val) { return sum + val; }, 0);
                totalDemandByProduct[product] = totalUnits;
                
                const material = modelData.products[product].material;
                const weight = modelData.products[product].weight;
                if (!materialDemand[material]) materialDemand[material] = 0;
                materialDemand[material] += totalUnits * weight;
            });
            
            const materialOrders = {};
            Object.keys(materialDemand).forEach(function(material) {
                if (materialDemand[material] > 0) {
                    materialOrders[material] = Math.ceil(materialDemand[material] / 1000 / 25) * 25;
                } else {
                    materialOrders[material] = 0;
                }
            });
            
            const factorySchedule = {};
            Object.keys(modelData.products).forEach(function(product) {
                factorySchedule[product] = new Array(modelData.months.length).fill(0);
            });
            
            const materialGroups = {};
            Object.keys(modelData.products).forEach(function(product) {
                const material = modelData.products[product].material;
                if (!materialGroups[material]) {
                    materialGroups[material] = [];
                }
                materialGroups[material].push(product);
            });
            
            Object.keys(materialGroups).forEach(function(material) {
                if (materialOrders[material] > 0) {
                    const products = materialGroups[material];
                    const productDemands = products.map(function(product) {
                        return {
                            name: product,
                            demand: totalDemandByProduct[product],
                            capacity: modelData.products[product].leadTime
                        };
                    });
                    
                    for (let month = Math.min(2, modelData.months.length - 1); month < modelData.months.length; month++) {
                        productDemands.forEach(function(productInfo) {
                            if (productInfo.demand > 0) {
                                const produce = Math.min(productInfo.demand, productInfo.capacity);
                                factorySchedule[productInfo.name][month] = produce;
                                productInfo.demand -= produce;
                            }
                        });
                        
                        if (productDemands.every(function(p) { return p.demand <= 0; })) break;
                    }
                }
            });

            updateFactoryScheduleTable(factorySchedule);
            window.calculatedFactorySchedule = factorySchedule;
            window.calculatedMaterialOrders = materialOrders;
        }

        function calculateMaterialOrders() {
            if (Object.keys(modelData.products).length === 0 || modelData.months.length === 0) {
                return;
            }
            
            const materialOrders = window.calculatedMaterialOrders || {};
            const materials = [];
            Object.values(modelData.products).forEach(function(product) {
                if (materials.indexOf(product.material) === -1) {
                    materials.push(product.material);
                }
            });
            
            const orderSchedule = {};
            materials.forEach(function(material) {
                const row = document.createElement('tr');
                let cells = '<td>' + material + ' (kg)</td>';
                orderSchedule[material].forEach(function(value) {
                    cells += '<td class="calculated">' + value + '</td>';
                });
                row.innerHTML = cells;
                tbody.appendChild(row);
            });
            
            window.calculatedMaterialOrderSchedule = orderSchedule;
        }

        function calculateProductInventory() {
            if (Object.keys(modelData.products).length === 0 || modelData.months.length === 0) {
                return;
            }
            
            const inventory = {};
            const factorySchedule = window.calculatedFactorySchedule || {};

            Object.keys(modelData.products).forEach(function(product) {
                const startingAmount = modelData.startingInventory.products[product] || 0;
                inventory[product] = [startingAmount];
                
                for (let month = 1; month < modelData.months.length; month++) {
                    const prevInventory = inventory[product][month - 1];
                    const production = factorySchedule[product] ? factorySchedule[product][month] : 0;
                    const forecast = modelData.clientForecast[product] || [];
                    const delivered = forecast[month] || 0;
                    
                    inventory[product][month] = prevInventory + production - delivered;
                }
            });

            const table = document.getElementById('productInventory');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            
            let headerHTML = '<tr><th>Product</th>';
            modelData.months.forEach(function(month) {
                headerHTML += '<th>' + month + '</th>';
            });
            headerHTML += '</tr>';
            thead.innerHTML = headerHTML;
            
            tbody.innerHTML = '';
            Object.keys(modelData.products).forEach(function(product) {
                const row = document.createElement('tr');
                row.className = 'product-' + product.toLowerCase();
                
                let cells = '<td>' + product + '</td>';
                inventory[product].forEach(function(value, monthIndex) {
                    let cellClass = 'calculated';
                    let cellStyle = '';
                    if (value < 0) {
                        cellStyle = 'background-color: #ffebee; color: #c62828; font-weight: bold;';
                    }
                    if (monthIndex === modelData.currentMonth) {
                        cellStyle += 'border: 3px solid #2196F3;';
                    }
                    cells += '<td class="' + cellClass + '" style="' + cellStyle + '">' + value + '</td>';
                });
                
                row.innerHTML = cells;
                tbody.appendChild(row);
            });
        }

        function calculateMaterialInventory() {
            if (Object.keys(modelData.products).length === 0 || modelData.months.length === 0) {
                return;
            }
            
            const factorySchedule = window.calculatedFactorySchedule || {};
            const materialOrders = window.calculatedMaterialOrderSchedule || {};
            
            const materials = [];
            Object.values(modelData.products).forEach(function(product) {
                if (materials.indexOf(product.material) === -1) {
                    materials.push(product.material);
                }
            });
            
            const inventory = {};
            
            materials.forEach(function(material) {
                const startingAmount = modelData.startingInventory.materials[material] || 0;
                inventory[material] = [startingAmount];
                
                for (let month = 1; month < modelData.months.length; month++) {
                    const prevInventory = inventory[material][month - 1];
                    
                    let delivered = 0;
                    if (month > 0 && materialOrders[material] && materialOrders[material].length > month - 1) {
                        delivered = materialOrders[material][month - 1] || 0;
                    }
                    
                    let materialUsed = 0;
                    if (month >= 2) {
                        Object.keys(modelData.products).forEach(function(product) {
                            if (modelData.products[product].material === material) {
                                const weight = modelData.products[product].weight / 1000;
                                const produced = factorySchedule[product] && factorySchedule[product].length > month 
                                    ? factorySchedule[product][month] || 0 
                                    : 0;
                                materialUsed += produced * weight;
                            }
                        });
                    }
                    
                    inventory[material][month] = prevInventory + delivered - materialUsed;
                }
            });

            const table = document.getElementById('materialInventory');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            
            let headerHTML = '<tr><th>Material</th>';
            modelData.months.forEach(function(month) {
                headerHTML += '<th>' + month + '</th>';
            });
            headerHTML += '</tr>';
            thead.innerHTML = headerHTML;
            
            tbody.innerHTML = '';
            materials.forEach(function(material) {
                const row = document.createElement('tr');
                let cells = '<td>' + material + ' (kg)</td>';
                const materialInventory = inventory[material] || new Array(modelData.months.length).fill(0);
                materialInventory.forEach(function(value) {
                    cells += '<td class="calculated">' + Math.round(value * 10) / 10 + '</td>';
                });
                row.innerHTML = cells;
                tbody.appendChild(row);
            });
        }

        function calculateProductInventoryForMonth(month) {
            const result = {};
            Object.keys(modelData.products).forEach(function(product) {
                result[product] = 0;
            });
            return result;
        }

        function calculateMaterialInventoryForMonth(month) {
            const result = {};
            const materials = [];
            Object.values(modelData.products).forEach(function(product) {
                if (materials.indexOf(product.material) === -1) {
                    materials.push(product.material);
                }
            });
            materials.forEach(function(material) {
                result[material] = 0;
            });
            return result;
        }

        function resetData() {
            if (confirm('Are you sure you want to reset all data? This will clear all saved information.')) {
                localStorage.removeItem('productionForecastData');
                location.reload();
            }
        }

        function updateAllTables() {
            updateProductLineupTable();
            updateClientForecastTable();
            updateMonthSelector();
        }

        function downloadExcel() {
            if (Object.keys(modelData.products).length === 0) {
                alert('Please load Excel data first before downloading.');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            const productData = [
                ['Product line up and its material and the weight of the product for production.'],
                ['Product Name', 'Product Weight', 'Material', 'Production Lead Time (units/month)']
            ];
            
            Object.keys(modelData.products).forEach(function(product) {
                const data = modelData.products[product];
                productData.push([product, data.weight + 'g', data.material, data.leadTime]);
            });
            
            const ws1 = XLSX.utils.aoa_to_sheet(productData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Product Lineup');
            
            const forecastData = [
                ['Client Forecast for Delivery Due Date'],
                [''].concat(modelData.months)
            ];
            
            Object.keys(modelData.products).forEach(function(product) {
                const forecast = modelData.clientForecast[product] || [];
                forecastData.push([product].concat(forecast));
            });
            
            const ws2 = XLSX.utils.aoa_to_sheet(forecastData);
            XLSX.utils.book_append_sheet(wb, ws2, 'ClientForcast');
            
            if (window.calculatedFactorySchedule) {
                const factoryData = getTableData('factorySchedule', 'Factory Line Schedule');
                const ws3 = XLSX.utils.aoa_to_sheet(factoryData);
                XLSX.utils.book_append_sheet(wb, ws3, 'FactoryLineSchedule');
            }
            
            if (window.calculatedMaterialOrderSchedule) {
                const materialOrderData = getTableData('materialOrder', 'Material Order Schedule');
                const ws4 = XLSX.utils.aoa_to_sheet(materialOrderData);
                XLSX.utils.book_append_sheet(wb, ws4, 'MaterialOrderSchedule');
            }
            
            const productInvData = getTableData('productInventory', 'Product Inventory');
            if (productInvData.length > 1) {
                const ws5 = XLSX.utils.aoa_to_sheet(productInvData);
                XLSX.utils.book_append_sheet(wb, ws5, 'ProductInventory');
            }
            
            const materialInvData = getTableData('materialInventory', 'Material Inventory');
            if (materialInvData.length > 1) {
                const ws6 = XLSX.utils.aoa_to_sheet(materialInvData);
                XLSX.utils.book_append_sheet(wb, ws6, 'MaterialInventory');
            }
            
            XLSX.writeFile(wb, 'ProductForecast_Updated.xlsx');
        }
        
        function getTableData(tableId, title) {
            const table = document.getElementById(tableId);
            if (!table) return [[title]];
            
            const rows = table.querySelectorAll('tr');
            const data = [[title]];
            
            rows.forEach(function(row) {
                const cells = row.querySelectorAll('th, td');
                if (cells.length > 0) {
                    const rowData = [];
                    cells.forEach(function(cell) {
                        const text = cell.textContent.trim();
                        if (text.includes('Please upload') || text.includes('will appear') || text.includes('will be calculated')) {
                            return;
                        }
                        rowData.push(isNaN(text) || text === '' ? text : parseFloat(text));
                    });
                    if (rowData.some(function(cell) { return cell !== '' && cell !== 0; })) {
                        data.push(rowData);
                    }
                }
            });
            
            return data;
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            try {
                console.log("Page loaded, initializing...");
                loadPersistedData();
                if (Object.keys(modelData.products).length === 0) {
                    console.log("No products found, showing empty tables");
                    showEmptyTables();
                } else {
                    console.log("Products found, calculating...");
                    calculateAll();
                }
            } catch (error) {
                console.error('Error during initialization:', error);
                showError('Initialization error: ' + error.message);
                showEmptyTables();
            }
        });

        // Auto-save with debouncing
        let saveTimeout;
        function autoSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(function() {
                try {
                    saveData();
                } catch (error) {
                    console.error('Error saving data:', error);
                    showError('Save error: ' + error.message);
                }
            }, 500);
        }

        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('editable')) {
                autoSave();
            }
        });
    </script>
</body>
</html>function(material) {
                orderSchedule[material] = new Array(modelData.months.length).fill(0);
                if (materialOrders[material] > 0) {
                    orderSchedule[material][modelData.currentMonth] = materialOrders[material];
                }
            });

            const table = document.getElementById('materialOrder');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            
            let headerHTML = '<tr><th>Material</th>';
            modelData.months.forEach(function(month) {
                headerHTML += '<th>' + month + '</th>';
            });
            headerHTML += '</tr>';
            thead.innerHTML = headerHTML;
            
            tbody.innerHTML = '';
            materials.forEach(